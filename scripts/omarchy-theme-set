#!/usr/bin/env bash
# Complete theme switcher for NixOS

if [[ -z $1 ]]; then
  echo "Usage: omarchy-theme-set <theme-name>"
  exit 1
fi

THEMES_DIR="$HOME/.config/omarchy/themes/"
CURRENT_THEME_DIR="$HOME/.config/omarchy/current/theme"

THEME_NAME=$(echo "$1" | sed -E 's/<[^>]+>//g' | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
THEME_PATH="$THEMES_DIR/$THEME_NAME"

# Check if theme exists
if [[ ! -d "$THEME_PATH" ]]; then
  echo "âŒ Theme '$THEME_NAME' does not exist in $THEMES_DIR"
  exit 1
fi

echo "ðŸŽ¨ Applying theme: $THEME_NAME"

# Update theme symlink
ln -nsf "$THEME_PATH" "$CURRENT_THEME_DIR"

# === App-specific theming ===

# 1. Waybar - link style and force restart
mkdir -p ~/.config/waybar
ln -nsf ~/.config/omarchy/current/theme/waybar.css ~/.config/waybar/style.css
if pgrep waybar >/dev/null; then
  pkill waybar
  sleep 0.3
  waybar >/dev/null 2>&1 &
  echo "  âœ“ Waybar restarted"
fi

# 2. Hyprland - reload for border colors
if [[ -f "$THEME_PATH/hyprland.conf" ]]; then
  hyprctl reload >/dev/null 2>&1
  echo "  âœ“ Hyprland reloaded"
fi

# 3. Mako notifications - link config and reload
if command -v makoctl >/dev/null 2>&1; then
  mkdir -p ~/.config/mako
  if [[ -f "$THEME_PATH/mako.ini" ]]; then
    ln -nsf "$THEME_PATH/mako.ini" ~/.config/mako/config
    makoctl reload >/dev/null 2>&1
    echo "  âœ“ Mako reloaded"
  fi
fi

# 4. Walker - just kill it, it will restart on next launch with new theme
if pgrep walker >/dev/null; then
  pkill walker >/dev/null 2>&1
  echo "  âœ“ Walker will reload on next launch"
fi

# 5. Alacritty - touch to trigger reload (imports theme via general.import)
if [[ -f ~/.config/alacritty/alacritty.toml ]]; then
  touch ~/.config/alacritty/alacritty.toml 2>/dev/null
  echo "  âœ“ Alacritty will reload"
fi

# 6. Kitty - send reload signal
killall -SIGUSR1 kitty 2>/dev/null && echo "  âœ“ Kitty reloaded"

# 7. Ghostty - send reload signal
killall -SIGUSR2 ghostty 2>/dev/null && echo "  âœ“ Ghostty reloaded"

# 8. Btop - send reload signal
pkill -SIGUSR2 btop 2>/dev/null && echo "  âœ“ Btop reloaded"

# 9. Browser theming
if [[ -f "$THEME_PATH/chromium.theme" ]]; then
  THEME_RGB=$(<"$THEME_PATH/chromium.theme")
  if command -v chromium >/dev/null 2>&1; then
    chromium --no-startup-window --set-theme-color="$THEME_RGB" 2>/dev/null &
  fi
  if command -v brave >/dev/null 2>&1; then
    brave --no-startup-window --set-theme-color="$THEME_RGB" 2>/dev/null &
  fi
  wait
  echo "  âœ“ Browser theme updated"
fi

# 10. Vesktop/Discord - generate and apply CSS
VESKTOP_CSS="$HOME/.config/vesktop/settings/quickCss.css"
mkdir -p "$(dirname "$VESKTOP_CSS")"

if [[ -f "$THEME_PATH/vesktop.css" ]]; then
  cp "$THEME_PATH/vesktop.css" "$VESKTOP_CSS"
  echo "  âœ“ Vesktop theme applied"
elif [[ -f "$THEME_PATH/waybar.css" ]]; then
  # Generate from waybar colors
  cat > "$VESKTOP_CSS" << 'EOFCSS'
/* Auto-generated from omarchy theme */
:root {
EOFCSS
  grep "@define-color" "$THEME_PATH/waybar.css" | while read -r line; do
    color_name=$(echo "$line" | sed -n 's/@define-color \([^ ]*\) \(.*\);/\1/p')
    color_value=$(echo "$line" | sed -n 's/@define-color \([^ ]*\) \(.*\);/\2/p')
    echo "  --${color_name}: ${color_value};" >> "$VESKTOP_CSS"
  done
  cat >> "$VESKTOP_CSS" << 'EOFCSS'
}

/* Discord UI theming */
.theme-dark {
  --background-primary: var(--background);
  --background-secondary: var(--background);
  --background-secondary-alt: var(--background);
  --background-tertiary: var(--background);
  --background-accent: var(--foreground);
  --text-normal: var(--foreground);
  --interactive-normal: var(--foreground);
}
EOFCSS
  echo "  âœ“ Vesktop theme generated"
fi

# 11. Wallpaper - set if background image exists
WALLPAPER_DIR="$THEME_PATH/backgrounds"
if [[ -d "$WALLPAPER_DIR" ]]; then
  # Find first image in backgrounds directory
  WALLPAPER=$(find "$WALLPAPER_DIR" -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) | head -1)
  if [[ -n "$WALLPAPER" ]]; then
    # Set wallpaper using hyprpaper or swaybg
    if command -v hyprctl >/dev/null 2>&1; then
      # For Hyprland, use hyprpaper or swaybg
      if pgrep -x swaybg >/dev/null; then
        pkill swaybg
      fi
      swaybg -i "$WALLPAPER" -m fill >/dev/null 2>&1 &
      echo "  âœ“ Wallpaper set: $(basename "$WALLPAPER")"
    fi
  fi
fi

echo ""
echo "âœ… Theme '$THEME_NAME' applied successfully!"

#!/usr/bin/env bash
# One-time setup script for themes
# Copies themes from git repo to ~/.config/theme-system/themes/
# Sets up default theme symlink

set -e

THEMES_SRC="$HOME/.config/nixos/theme-system/themes"
THEMES_DEST="$HOME/.config/theme-system/themes"
CURRENT_LINK="$HOME/.config/theme-system/current/theme"
DEFAULT_THEME="tokyo-night"

echo "ðŸŽ¨ Theme Theme Setup"
echo ""

# Check if source exists
if [ ! -d "$THEMES_SRC" ]; then
    echo "âŒ Error: Themes source not found at $THEMES_SRC"
    echo "   Clone theme repo: git clone https://github.com/qreenify/nixos-config ~/git/omarchy"
    exit 1
fi

# Backup existing themes if they exist
if [ -d "$THEMES_DEST" ]; then
    echo "ðŸ“¦ Backing up existing themes..."
    mv "$THEMES_DEST" "${THEMES_DEST}.backup.$(date +%Y%m%d-%H%M%S)"
fi

# Copy themes
echo "ðŸ“¥ Copying themes from $THEMES_SRC"
mkdir -p "$HOME/.config/theme-system"
cp -r "$THEMES_SRC" "$THEMES_DEST"
chmod -R u+w "$THEMES_DEST"

# List available themes
echo ""
echo "ðŸ“‹ Available themes:"
ls -1 "$THEMES_DEST" | sed 's/^/   - /'

# Set up default theme
echo ""
if [ -L "$CURRENT_LINK" ] || [ -e "$CURRENT_LINK" ]; then
    current_theme=$(basename "$(readlink "$CURRENT_LINK" 2>/dev/null || echo "$DEFAULT_THEME")")
    echo "ðŸ”— Current theme: $current_theme"
    read -p "   Keep current theme? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        mkdir -p "$(dirname "$CURRENT_LINK")"
        ln -nsf "$THEMES_DEST/$DEFAULT_THEME" "$CURRENT_LINK"
        echo "âœ… Set default theme: $DEFAULT_THEME"
    fi
else
    mkdir -p "$(dirname "$CURRENT_LINK")"
    ln -nsf "$THEMES_DEST/$DEFAULT_THEME" "$CURRENT_LINK"
    echo "âœ… Set default theme: $DEFAULT_THEME"
fi

echo ""
echo "âœ¨ Setup complete!"
echo ""
echo "Usage:"
echo "  theme              # Open graphical theme browser"
echo "  theme-set <theme-name>  # Switch theme via command"
echo ""

#!/usr/bin/env python3
"""
Theme Theme Browser
A GUI application to browse and switch themes with preview images.
"""

import gi
gi.require_version('Gtk', '3.0')
from gi.repository import Gtk, GdkPixbuf, Gdk
import os
import subprocess
from pathlib import Path

class ThemeBrowser(Gtk.Window):
    def __init__(self):
        super().__init__(title="Theme Theme Browser")
        self.set_default_size(900, 600)
        self.set_position(Gtk.WindowPosition.CENTER)

        # Paths
        self.themes_dir = Path.home() / ".config/theme-system/themes"
        self.current_link = Path.home() / ".config/theme-system/current/theme"

        # Check if themes exist
        if not self.themes_dir.exists():
            self.show_error_dialog()
            return

        # Get current theme
        self.current_theme = self.get_current_theme()

        # Create main layout
        hbox = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=0)
        self.add(hbox)

        # Left panel (1/3) - Theme list
        left_panel = self.create_theme_list()
        hbox.pack_start(left_panel, False, True, 0)

        # Right panel (2/3) - Preview image
        right_panel = self.create_preview_panel()
        hbox.pack_start(right_panel, True, True, 0)

        # Load themes
        self.load_themes()

    def get_current_theme(self):
        """Get currently active theme name"""
        try:
            if self.current_link.is_symlink():
                return self.current_link.resolve().name
        except:
            pass
        return None

    def create_theme_list(self):
        """Create left panel with theme list"""
        vbox = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=0)
        vbox.set_size_request(300, -1)

        # Header
        header = Gtk.Label()
        header.set_markup("<b>Available Themes</b>")
        header.set_margin_top(10)
        header.set_margin_bottom(10)
        vbox.pack_start(header, False, True, 0)

        # Scrolled window for theme list
        scrolled = Gtk.ScrolledWindow()
        scrolled.set_policy(Gtk.PolicyType.NEVER, Gtk.PolicyType.AUTOMATIC)
        vbox.pack_start(scrolled, True, True, 0)

        # ListBox for themes
        self.listbox = Gtk.ListBox()
        self.listbox.set_selection_mode(Gtk.SelectionMode.SINGLE)
        self.listbox.connect("row-selected", self.on_theme_selected)
        scrolled.add(self.listbox)

        # Apply button
        button_box = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=6)
        button_box.set_margin_top(10)
        button_box.set_margin_bottom(10)
        button_box.set_margin_start(10)
        button_box.set_margin_end(10)

        self.apply_button = Gtk.Button(label="Apply Theme")
        self.apply_button.connect("clicked", self.on_apply_clicked)
        self.apply_button.set_sensitive(False)
        button_box.pack_start(self.apply_button, True, True, 0)

        vbox.pack_start(button_box, False, True, 0)

        return vbox

    def create_preview_panel(self):
        """Create right panel with preview image"""
        vbox = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
        vbox.set_margin_start(20)
        vbox.set_margin_end(20)
        vbox.set_margin_top(20)
        vbox.set_margin_bottom(20)

        # Theme name label
        self.theme_name_label = Gtk.Label()
        self.theme_name_label.set_markup("<span size='x-large'><b>Select a theme</b></span>")
        vbox.pack_start(self.theme_name_label, False, True, 0)

        # Scrolled window for image
        scrolled = Gtk.ScrolledWindow()
        scrolled.set_policy(Gtk.PolicyType.AUTOMATIC, Gtk.PolicyType.AUTOMATIC)
        vbox.pack_start(scrolled, True, True, 0)

        # Image widget
        self.preview_image = Gtk.Image()
        scrolled.add(self.preview_image)

        return vbox

    def load_themes(self):
        """Load all available themes into the list"""
        themes = sorted([d.name for d in self.themes_dir.iterdir() if d.is_dir()])

        for theme_name in themes:
            row = Gtk.ListBoxRow()
            hbox = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)
            hbox.set_margin_top(8)
            hbox.set_margin_bottom(8)
            hbox.set_margin_start(12)
            hbox.set_margin_end(12)

            # Theme name
            label = Gtk.Label(label=self.format_theme_name(theme_name))
            label.set_xalign(0)
            hbox.pack_start(label, True, True, 0)

            # Current indicator
            if theme_name == self.current_theme:
                current_label = Gtk.Label()
                current_label.set_markup("<span foreground='#00D4AA'>‚óè</span>")
                hbox.pack_start(current_label, False, True, 0)

            row.add(hbox)
            row.theme_name = theme_name
            self.listbox.add(row)

            # Select current theme
            if theme_name == self.current_theme:
                self.listbox.select_row(row)

    def format_theme_name(self, name):
        """Format theme name for display"""
        return name.replace('-', ' ').title()

    def on_theme_selected(self, listbox, row):
        """Handle theme selection"""
        if row is None:
            return

        theme_name = row.theme_name
        self.selected_theme = theme_name

        # Update theme name label
        self.theme_name_label.set_markup(
            f"<span size='x-large'><b>{self.format_theme_name(theme_name)}</b></span>"
        )

        # Load preview image
        preview_path = self.themes_dir / theme_name / "preview.png"
        if preview_path.exists():
            try:
                pixbuf = GdkPixbuf.Pixbuf.new_from_file_at_scale(
                    str(preview_path),
                    width=600,
                    height=400,
                    preserve_aspect_ratio=True
                )
                self.preview_image.set_from_pixbuf(pixbuf)
            except Exception as e:
                self.preview_image.set_from_icon_name("image-missing", Gtk.IconSize.DIALOG)
        else:
            self.preview_image.set_from_icon_name("image-missing", Gtk.IconSize.DIALOG)

        # Enable apply button if different from current
        self.apply_button.set_sensitive(theme_name != self.current_theme)

    def on_apply_clicked(self, button):
        """Apply selected theme"""
        if not hasattr(self, 'selected_theme'):
            return

        try:
            # Run theme-set command
            subprocess.run(
                ["theme-set", self.selected_theme],
                check=True,
                capture_output=True
            )

            # Show success dialog
            dialog = Gtk.MessageDialog(
                transient_for=self,
                flags=0,
                message_type=Gtk.MessageType.INFO,
                buttons=Gtk.ButtonsType.OK,
                text="Theme Applied"
            )
            dialog.format_secondary_text(
                f"Theme '{self.format_theme_name(self.selected_theme)}' has been applied."
            )
            dialog.run()
            dialog.destroy()

            # Close window
            self.destroy()

        except subprocess.CalledProcessError as e:
            # Show error dialog
            dialog = Gtk.MessageDialog(
                transient_for=self,
                flags=0,
                message_type=Gtk.MessageType.ERROR,
                buttons=Gtk.ButtonsType.OK,
                text="Error Applying Theme"
            )
            dialog.format_secondary_text(
                f"Failed to apply theme: {e.stderr.decode() if e.stderr else 'Unknown error'}"
            )
            dialog.run()
            dialog.destroy()

    def show_error_dialog(self):
        """Show error when themes directory doesn't exist"""
        dialog = Gtk.MessageDialog(
            transient_for=self,
            flags=0,
            message_type=Gtk.MessageType.ERROR,
            buttons=Gtk.ButtonsType.OK,
            text="Themes Not Found"
        )
        dialog.format_secondary_text(
            f"Themes directory not found at:\n{self.themes_dir}\n\n"
            "Run: theme-setup"
        )
        dialog.run()
        dialog.destroy()
        self.destroy()

def main():
    win = ThemeBrowser()
    win.connect("destroy", Gtk.main_quit)
    win.show_all()
    Gtk.main()

if __name__ == "__main__":
    main()

#!/usr/bin/env bash
# Interactive wallpaper selector with terminal preview

# Find all wallpaper images from ALL themes
THEMES_DIR="$HOME/.config/theme/themes"
WALLPAPERS=""

# Search all theme directories for wallpapers
for theme_dir in "$THEMES_DIR"/*/backgrounds; do
  if [[ -d "$theme_dir" ]]; then
    theme_name=$(basename "$(dirname "$theme_dir")")
    # Find wallpapers and prefix with theme name
    while IFS= read -r wallpaper; do
      if [[ -n "$wallpaper" ]]; then
        # Format: "theme-name | wallpaper-path"
        WALLPAPERS+="[$theme_name] $(basename "$wallpaper")|$wallpaper"$'\n'
      fi
    done < <(find "$theme_dir" -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) 2>/dev/null)
  fi
done

if [[ -z "$WALLPAPERS" ]]; then
  echo "âŒ No wallpaper images found in any theme"
  exit 1
fi

# Count wallpapers
COUNT=$(echo -n "$WALLPAPERS" | grep -c '^')
echo "ðŸŽ¨ Found $COUNT wallpaper(s) from all themes"
echo ""

# Use fzf with image preview
# Detect terminal and use the best preview method available
PREVIEW_SCRIPT="/tmp/fzf-preview-$$.sh"

# Check if running in Kitty or Ghostty (both support Kitty graphics protocol)
if [[ "$TERM" == "xterm-kitty" ]] || [[ "$TERM" == "xterm-ghostty" ]] || command -v kitty >/dev/null 2>&1; then
  # Kitty/Ghostty terminal - use Kitty image protocol for pixel-perfect preview
  cat > "$PREVIEW_SCRIPT" << 'EOF'
#!/bin/sh
# Extract path from "theme | wallpaper|path" format
WALLPAPER_PATH=$(echo "$1" | cut -d'|' -f2)
if command -v kitty >/dev/null 2>&1; then
  kitty +kitten icat --clear --transfer-mode=memory --stdin=no --place=80x40@0x0 "$WALLPAPER_PATH" 2>/dev/null
else
  chafa --size 80x40 --symbols block --colors 256 "$WALLPAPER_PATH" 2>/dev/null
fi
EOF
else
  # Other terminals (Alacritty, etc.) - use chafa for text-based preview
  cat > "$PREVIEW_SCRIPT" << 'EOF'
#!/bin/sh
# Extract path from "theme | wallpaper|path" format
WALLPAPER_PATH=$(echo "$1" | cut -d'|' -f2)
chafa --size 80x40 --symbols block --colors 256 "$WALLPAPER_PATH" 2>/dev/null || echo "Preview not available"
EOF
fi

chmod +x "$PREVIEW_SCRIPT"

SELECTED=$(echo -e "$WALLPAPERS" | fzf \
  --preview "$PREVIEW_SCRIPT {}" \
  --preview-window=right:70% \
  --prompt="Select wallpaper > " \
  --height=100% \
  --header="Mix & match wallpapers from all themes | Use â†‘â†“ to navigate, Enter to select, Esc to cancel" \
)

# Clean up preview script
rm -f "$PREVIEW_SCRIPT"

if [[ -z "$SELECTED" ]]; then
  echo "Cancelled."
  exit 0
fi

# Extract actual wallpaper path from "[theme] name|path" format
WALLPAPER_PATH=$(echo "$SELECTED" | cut -d'|' -f2)
THEME_NAME=$(echo "$SELECTED" | cut -d'|' -f1 | sed 's/\[//;s/\].*//')

echo "ðŸ–¼ï¸  Setting wallpaper: $(basename "$WALLPAPER_PATH") from theme '$THEME_NAME'"

# Kill existing swaybg instances
pkill -9 swaybg 2>/dev/null
sleep 0.2

# Set the selected wallpaper
swaybg -i "$WALLPAPER_PATH" -m fill >/dev/null 2>&1 &

echo "âœ… Wallpaper applied!"

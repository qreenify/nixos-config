#!/usr/bin/env bash
# Control Music (Apple Music/Spotify PWA) volume specifically

ACTION="$1"  # up, down, or mute

# Find ALL Music sink-input IDs
# Music PWAs run in browser, check parent process for --app= URL
SINK_INPUTS=()
for stream in $(wpctl status | grep -A 50 "Streams:" | grep -oP '^\s*\K\d+(?=\.)'); do
    # Get the process ID for this stream
    PID=$(pw-cli info "$stream" 2>/dev/null | grep "application.process.id" | grep -oP '"\K[0-9]+')

    if [ -n "$PID" ]; then
        # Get parent PID and check its cmdline for Music PWA
        PARENT_PID=$(ps -o ppid= -p "$PID" 2>/dev/null | tr -d ' ')
        if [ -n "$PARENT_PID" ]; then
            if grep -qiE "app=.*(music\.apple|spotify)" /proc/"$PARENT_PID"/cmdline 2>/dev/null; then
                SINK_INPUTS+=("$stream")
            fi
        fi
    fi
done

if [ ${#SINK_INPUTS[@]} -eq 0 ]; then
    notify-send "Music Volume" "Music app not found (make sure Apple Music or Spotify is playing)" -t 2000
    exit 1
fi

case "$ACTION" in
    up)
        for SINK_INPUT in "${SINK_INPUTS[@]}"; do
            wpctl set-volume -l 1.0 "$SINK_INPUT" 5%+
        done
        # Get volume from first stream for display
        VOLUME=$(wpctl get-volume "${SINK_INPUTS[0]}" | awk '{print int($2 * 100)}')
        notify-send "Music Volume" "Volume: ${VOLUME}%" -t 1000
        ;;
    down)
        for SINK_INPUT in "${SINK_INPUTS[@]}"; do
            wpctl set-volume "$SINK_INPUT" 5%-
        done
        # Get volume from first stream for display
        VOLUME=$(wpctl get-volume "${SINK_INPUTS[0]}" | awk '{print int($2 * 100)}')
        notify-send "Music Volume" "Volume: ${VOLUME}%" -t 1000
        ;;
    mute)
        for SINK_INPUT in "${SINK_INPUTS[@]}"; do
            wpctl set-mute "$SINK_INPUT" toggle
        done
        # Get mute status from first stream for display
        MUTED=$(wpctl get-volume "${SINK_INPUTS[0]}" | grep -q "MUTED" && echo "Muted" || echo "Unmuted")
        notify-send "Music Volume" "$MUTED" -t 1000
        ;;
    *)
        echo "Usage: $0 {up|down|mute}"
        exit 1
        ;;
esac

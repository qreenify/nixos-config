#!/usr/bin/env bash
# Fast Vesktop volume control using wpctl with cache

ACTION="$1"
CACHE_FILE="/tmp/app-volume-cache-$USER/vesktop"

# Read stream IDs from cache (one ID per line)
SINK_INPUTS=()
if [[ -f "$CACHE_FILE" ]]; then
    while IFS= read -r stream_id; do
        [[ -n "$stream_id" ]] && SINK_INPUTS+=("$stream_id")
    done < "$CACHE_FILE"
fi

# Exit silently if app not found
[[ ${#SINK_INPUTS[@]} -eq 0 ]] && exit 1

# Direct wpctl calls - no parsing, no subprocesses
case "$ACTION" in
    up)
        for id in "${SINK_INPUTS[@]}"; do
            wpctl set-volume -l 1.0 "$id" 5%+
        done
        ;;
    down)
        for id in "${SINK_INPUTS[@]}"; do
            wpctl set-volume "$id" 5%-
        done
        ;;
    mute)
        for id in "${SINK_INPUTS[@]}"; do
            wpctl set-mute "$id" toggle
        done
        ;;
    *)
        exit 1
        ;;
esac

# Signal waybar to update
pkill -RTMIN+8 waybar 2>/dev/null

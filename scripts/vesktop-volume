#!/usr/bin/env bash
# Control Vesktop (Discord) volume specifically (cache-based, instant)

ACTION="$1"  # up, down, or mute
CACHE_FILE="/tmp/app-volume-cache-$USER/vesktop"

# Read stream IDs from cache
SINK_INPUTS=()
if [[ -f "$CACHE_FILE" ]]; then
    while IFS= read -r stream_id; do
        [[ -n "$stream_id" ]] && SINK_INPUTS+=("$stream_id")
    done < "$CACHE_FILE"
fi

if [ ${#SINK_INPUTS[@]} -eq 0 ]; then
    # Silently exit if app not found
    exit 1
fi

case "$ACTION" in
    up)
        for SINK_INPUT in "${SINK_INPUTS[@]}"; do
            wpctl set-volume -l 1.0 "$SINK_INPUT" 5%+
        done
        ;;
    down)
        for SINK_INPUT in "${SINK_INPUTS[@]}"; do
            wpctl set-volume "$SINK_INPUT" 5%-
        done
        ;;
    mute)
        for SINK_INPUT in "${SINK_INPUTS[@]}"; do
            wpctl set-mute "$SINK_INPUT" toggle
        done
        ;;
    *)
        echo "Usage: $0 {up|down|mute}"
        exit 1
        ;;
esac

# Signal waybar to update immediately
pkill -RTMIN+8 waybar 2>/dev/null

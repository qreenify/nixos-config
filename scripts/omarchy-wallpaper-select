#!/usr/bin/env bash
# Interactive wallpaper selector with terminal preview

# Detect current theme from symlink, cleaning up any double slashes
if [[ -n "$1" ]]; then
  THEME_NAME="$1"
else
  THEME_LINK=$(readlink -f ~/.config/omarchy/current/theme)
  THEME_NAME=$(basename "$THEME_LINK")
fi

WALLPAPER_DIR="$HOME/.config/omarchy/themes/$THEME_NAME/backgrounds"

if [[ ! -d "$WALLPAPER_DIR" ]]; then
  echo "âŒ No wallpapers found for theme '$THEME_NAME'"
  echo "   Directory: $WALLPAPER_DIR"
  exit 1
fi

# Find all wallpaper images
WALLPAPERS=$(find "$WALLPAPER_DIR" -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) 2>/dev/null)

if [[ -z "$WALLPAPERS" ]]; then
  echo "âŒ No wallpaper images found in $WALLPAPER_DIR"
  exit 1
fi

# Count wallpapers
COUNT=$(echo "$WALLPAPERS" | wc -l)
echo "ðŸŽ¨ Found $COUNT wallpaper(s) for theme '$THEME_NAME'"
echo ""

# Use fzf with image preview
# Detect terminal and use the best preview method available
PREVIEW_SCRIPT="/tmp/fzf-preview-$$.sh"

# Check if running in Kitty or Ghostty (both support Kitty graphics protocol)
if [[ "$TERM" == "xterm-kitty" ]] || [[ "$TERM" == "xterm-ghostty" ]] || command -v kitty >/dev/null 2>&1; then
  # Kitty/Ghostty terminal - use Kitty image protocol for pixel-perfect preview
  cat > "$PREVIEW_SCRIPT" << 'EOF'
#!/bin/sh
if command -v kitty >/dev/null 2>&1; then
  kitty +kitten icat --clear --transfer-mode=memory --stdin=no --place=80x40@0x0 "$1" 2>/dev/null
else
  chafa --size 80x40 --symbols block --colors 256 "$1" 2>/dev/null
fi
EOF
else
  # Other terminals (Alacritty, etc.) - use chafa for text-based preview
  cat > "$PREVIEW_SCRIPT" << 'EOF'
#!/bin/sh
chafa --size 80x40 --symbols block --colors 256 "$1" 2>/dev/null || echo "Preview not available"
EOF
fi

chmod +x "$PREVIEW_SCRIPT"

SELECTED=$(echo "$WALLPAPERS" | fzf \
  --preview "$PREVIEW_SCRIPT {}" \
  --preview-window=right:70% \
  --prompt="Select wallpaper > " \
  --height=100% \
  --header="Theme: $THEME_NAME | Use â†‘â†“ to navigate, Enter to select, Esc to cancel" \
)

# Clean up preview script
rm -f "$PREVIEW_SCRIPT"

if [[ -z "$SELECTED" ]]; then
  echo "Cancelled."
  exit 0
fi

echo "ðŸ–¼ï¸  Setting wallpaper: $(basename "$SELECTED")"

# Kill existing swaybg instances
pkill -9 swaybg 2>/dev/null
sleep 0.2

# Set the selected wallpaper
swaybg -i "$SELECTED" -m fill >/dev/null 2>&1 &

echo "âœ… Wallpaper applied!"

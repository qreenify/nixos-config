#!/usr/bin/env bash
# Smart volume control - targets the most recently focused audio stream
# Usage: smart-volume-control [up|down|mute]

MONITOR_SCRIPT="${HOME}/.config/nixos/scripts/app-volume-monitor-multi"
[[ ! -x "$MONITOR_SCRIPT" ]] && MONITOR_SCRIPT="${HOME}/.script/app-volume-monitor-multi"

ACTION="$1"
AMOUNT="${2:-5}"  # Default 5% change

# Get currently focused window PID
get_focused_pid() {
    hyprctl activewindow -j 2>/dev/null | jq -r '.pid' 2>/dev/null
}

# Find audio stream for given PID (or its parent)
find_stream_for_pid() {
    local target_pid=$1
    local streams=$("$MONITOR_SCRIPT" 2>/dev/null)

    # First try direct PID match
    local stream=$(echo "$streams" | jq -r ".[] | select(.pid == $target_pid)" 2>/dev/null | head -1)

    if [[ -n "$stream" ]] && [[ "$stream" != "null" ]]; then
        echo "$stream"
        return 0
    fi

    # Try checking if any stream's parent matches
    local ppid=$(ps -o ppid= -p "$target_pid" 2>/dev/null | tr -d ' ')
    if [[ -n "$ppid" ]] && [[ "$ppid" != "1" ]]; then
        stream=$(echo "$streams" | jq -r ".[] | select(.pid == $ppid)" 2>/dev/null | head -1)
        if [[ -n "$stream" ]] && [[ "$stream" != "null" ]]; then
            echo "$stream"
            return 0
        fi
    fi

    return 1
}

# Get last active stream from cache if focus detection fails
get_cached_stream() {
    local cache_file="/tmp/last-audio-stream-$USER"
    if [[ -f "$cache_file" ]]; then
        local stream_id=$(cat "$cache_file")
        # Verify stream still exists
        local streams=$("$MONITOR_SCRIPT" 2>/dev/null)
        local stream=$(echo "$streams" | jq -r ".[] | select(.stream_id == $stream_id)" 2>/dev/null)
        if [[ -n "$stream" ]] && [[ "$stream" != "null" ]]; then
            echo "$stream"
            return 0
        fi
    fi
    return 1
}

# Save stream as last active
cache_stream() {
    local stream_id=$1
    echo "$stream_id" > "/tmp/last-audio-stream-$USER"
}

# Main logic
main() {
    if [[ -z "$ACTION" ]]; then
        echo "Usage: smart-volume-control [up|down|mute]"
        exit 1
    fi

    # Try to find stream for focused window
    local focused_pid=$(get_focused_pid)
    local stream=""

    if [[ -n "$focused_pid" ]] && [[ "$focused_pid" != "null" ]]; then
        stream=$(find_stream_for_pid "$focused_pid")
    fi

    # Fallback to last active stream
    if [[ -z "$stream" ]]; then
        stream=$(get_cached_stream)
    fi

    # If still no stream, try to get the first available stream
    if [[ -z "$stream" ]]; then
        stream=$("$MONITOR_SCRIPT" 2>/dev/null | jq -r '.[0]' 2>/dev/null)
    fi

    if [[ -z "$stream" ]] || [[ "$stream" == "null" ]]; then
        # No audio streams found
        exit 0
    fi

    # Extract stream ID
    local stream_id=$(echo "$stream" | jq -r '.stream_id' 2>/dev/null)
    [[ -z "$stream_id" ]] || [[ "$stream_id" == "null" ]] && exit 1

    # Cache this stream as last active
    cache_stream "$stream_id"

    # Perform action
    case "$ACTION" in
        up)
            wpctl set-volume "$stream_id" "${AMOUNT}%+"
            ;;
        down)
            wpctl set-volume "$stream_id" "${AMOUNT}%-"
            ;;
        mute)
            wpctl set-mute "$stream_id" toggle
            ;;
        *)
            echo "Unknown action: $ACTION"
            exit 1
            ;;
    esac
}

main
